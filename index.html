<!DOCTYPE HTML>
<html lang = "en">
<head>
  <title>cFrame</title>
  <meta charset = "UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="tachyons.css">
  <style>
/*
    .videobox {
      width: 50%;
    }
*/
    #replay-bar {
    height: 75px;
    transform: translateY(100%);
    -webkit-transform: translateY(100%);
    }
    .slide-in {
      animation: slide-in 0.5s forwards;
      -webkit-animation: slide-in 0.5s forwards;
    }
    @keyframes slide-in {
        100% { transform: translateY(0%); }
    }
    @-webkit-keyframes slide-in {
        100% { -webkit-transform: translateY(0%); }
    }
    .click-region {
      width: 50%;
      height: 100%;
      position: absolute;
    }
    .right {
      right:0px;
      top: 0px;
    }
    .left {
      left:0px;
      top: 0px;
    }
    .button-right {
      transform: translateX(50%);
    }
    .button-left {
      transform: translateX(-50%);
    }
    .click-region {opacity: 0}
/*    .click-region:hover {opacity: 1}*/
    .circle {
      stroke: #ffffff;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-dasharray: 100;
/*      animation: progress 4s ease-out forwards;*/
    }
    .circle-box {
      height: 2.2rem;
      width: 2.2rem;
    }
    #current_frame {
      padding-top: .25rem;
      padding-left:.04rem;
    }
    @keyframes progress {
      0% {
        stroke-dasharray: 0 100;
      }
    }
  </style>
</head>
<body class="w-100 center black-90 bg-white f5-ns f6 relative pa2 pa0-ns sans-serif">
  <div class="dt center">
    <div class="dt relative">
<!--      <div class="w5 pr5 pr0-ns center-ns large-shadow bottom">-->
      <div>
        <div class="center bg-black overflow-hidden relative">
          <video muted playsinline preload="auto" class="vh-100 relative" id="video">
            <source src="test.webm" type="video/webm" />
            <source src="test.mp4" type="video/mp4" />
          </video>
          <div class="click-region absolute right" onclick="advanceFrame(1);">
            <div class="flex items-center h-100 fr">
              <div class="bg-white h3 w3 br-100 button-right">
                <p class="w-100 tl pl2 f4">→</p>
              </div>
            </div>
          </div>
          <div class="click-region absolute left" onclick="decrementFrame();">
            <div class="flex items-center h-100 fl">
              <div class="bg-white h3 w3 br-100 button-left">
                <p class="w-100 tr pr2 f4">←</p>
              </div>
            </div>
          </div>
          <div class="absolute tc bottom-0 w-100" id="">
            <div class="white ma3">
              <div class="dib v-mid relative tc circle-box">
                <span class="f3 absolute w-100 tc" id="current_frame">0</span>
                <svg viewBox="0 0 36 36" class="" transform="translate(0,0) scale(-1, 1)">
                  <path class="circle" id="progress_circle"
                    stroke-dasharray="100" stroke-dashoffset="100"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                </svg>
              </div>
              <div class="w2 dib v-mid ">
              <span class="bl v-mid"></span>
              <span class="v-mid f3 fw3 pl2 ml1" id="final_frame">5</span></div></div>
          </div>
          <div class="w-100 absolute tc bottom-0" id="replay-bar">
            <a class="f4 link ph4 br4 pv3 mb2 dib black relative bottom-0 bg-white shadow-3 ma2 fw3" href="#0" onclick="sliderClicked();">Back to start</a>
          </div>
<!--        <p class="white f6 ma1 absolute w-100"><span class="b">c</span>Frame</p>-->
        </div>
      </div>
    </div>
  </div>
  <script>
    
    var video = document.getElementById('video');
    var replay_bar = document.getElementById('replay-bar');
    var displayed_frame = document.getElementById('current_frame');
    var final_frame = document.getElementById('final_frame');
    var circle = document.getElementById('progress_circle');
    
    // whilte playing have number opacity 50% or something and progress bar moving

    var key = [
      {time: 0, type: "hold"},
      {time: 1, type: "hold"},
      {time: 2, type: "hold"},
      {time: 3, type: "hold"},
      {time: 4, type: "hold"},
      {time: 5, type: "hold"}
    ]

    var frame = 0;
    var previousFrame = 0;
    var ended = false;
    
    const advanceFrame = () => {
      if (!inRange(frame)) {return;} // break if outside frame range
      else {
        let step = 1;
        if (video.playing) {
          video.pause();
          video.currentTime = key[frame].time;
          window.requestAnimationFrame(onTimeUpdate);
        }
        else {previousFrame = frame; frame += step;}
        changeDisplayedFrame(displayed_frame, frame);
      }
    }
    
    const decrementFrame = () => {
      let step = -1;
      let framechange = 0;
      if (video.playing) {framechange = -1;}
      if (!inRange(frame + step)) {
        return;
      }
      else {
        if (finalFrame) {removeSlider();}
        video.pause();
        video.currentTime = key[frame + step].time;
        previousFrame = frame + step;
        frame += framechange;
        window.requestAnimationFrame(onTimeUpdate);
        changeDisplayedFrame(displayed_frame, frame);
      }
    }
    
    const updateProgress = (v) => {
      circle.style.strokeDashoffset = v;
    }
    
    const finalFrame = () => {
      if (frame == key.length - 1) {return true;}
      else {return false;}
    }
    
    const firstFrame = () => {
      if (frame == 0) {return true;}
      else {return false;}
    }
    
    const inRange = (f) => {
      if (f < key.length-1 && f >= 0) {return true;}
      else {return false;}
    }
    
    const onTimeUpdate = () => {
        if (video.currentTime >= (key[frame].time - 0.05)) {
          video.pause();
          updateProgress(0);
          displayed_frame.style.opacity = "1";
          if (finalFrame()){handleEnd()}
          window.requestAnimationFrame(onTimeUpdate);
        } else {
          video.play();
          updateProgress(getProgress(previousFrame, frame, video.currentTime));
          displayed_frame.style.opacity = "0.5";
          window.requestAnimationFrame(onTimeUpdate);
        }
    }
    window.requestAnimationFrame(onTimeUpdate)
    
    Object.defineProperty(HTMLMediaElement.prototype, 'playing', {
    get: function(){
        return !!(this.currentTime > 0 && !this.paused && !this.ended && this.readyState > 2);
      }
    })
    
    const getProgress = (lastFrame, nextFrame, currentTime) => {
      let offsetTime = key[nextFrame].time - currentTime;
      let timeDifference = Math.abs(key[nextFrame].time - key[lastFrame].time);
      return 100 * (offsetTime / timeDifference);
    }
    
    const handleEnd = () => {
      addSlider();
    }
    
    const sliderClicked = () => {
      toStart();
      removeSlider();
    }
    
    const addSlider = () => {
      replay_bar.classList.add('slide-in');
    }
    
    const removeSlider = () => {
      replay_bar.classList.remove('slide-in');
    }
    
    const changeDisplayedFrame = (object, f) => {
      let displayedFrame = f;
      while( object.firstChild ) {
        object.removeChild( object.firstChild );
      }
      object.appendChild( document.createTextNode(displayedFrame.toString()) );
    }
    
    const toStart = () => {
      video.pause();
      video.currentTime = 0;
      frame = 0;
      changeDisplayedFrame(displayed_frame, frame);
      window.requestAnimationFrame(onTimeUpdate)
    }
    
    changeDisplayedFrame(final_frame, key.length - 1);
    
//    video.addEventListener("timeupdate", function(){pauseAt(2, this)})
    
//    function checkPaused(v) {
//      v.paused?v.play():v.pause();
//    }
    
    // TODO
    // Block any tap until video is loaded
    // Progressively load video ?? (don't block beginning if not loaded)
    // Full screen on mobile
    //      - detect if on mobile
    //      - if so, go full screen?
    // Bleed areas on mobile -- video should bleed vertically (fit 100% horizontally), but buttons are always sized to the screen
    // touching and holding initiates carosel navigation (with video thumbnails) - scrolling left and right scrolls through frames. single tap on frame selects as current frame
    // help menu that has animations for all behaviors -- tap to advance/replay, double tap to skip ahead/back, hold to initiate carosel
    
    //MAyBE
    // on tap, confirm action with < or > symbol fading in. Confirm double tap with |< or >| fading in
  </script>
</body>
